<!DOCTYPE html>
<html lang="es">
<head>
    <!-- ... (el resto del head permanece igual) ... -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
</head>
<body>
    <!-- ... (el resto del body permanece igual hasta el script) ... -->

    <script>
        // ... (las variables y funciones anteriores permanecen iguales) ...

        function finalizePurchase() {
            const paymentMethod = document.getElementById("paymentMethod").value;
            const receiptContent = document.getElementById("receiptContent");
            const now = new Date();
            ticketNumber++;

            let receiptHTML = `
                <h6>Ticket #${ticketNumber}</h6>
                <p>Fecha: ${now.toLocaleString()}</p>
                <p>Forma de Pago: ${paymentMethod}</p>
                <hr>
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cant.</th>
                            <th>Precio</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            let whatsappMessage = `*Ticket #${ticketNumber}*%0A`;
            whatsappMessage += `Fecha: ${now.toLocaleString()}%0A`;
            whatsappMessage += `Forma de Pago: ${paymentMethod}%0A%0A`;

            for (const productId in cart) {
                const item = cart[productId];
                const subtotal = item.price * item.quantity;
                receiptHTML += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>$${item.price.toFixed(2)}</td>
                        <td>$${subtotal.toFixed(2)}</td>
                    </tr>
                `;

                whatsappMessage += `${item.name} x${item.quantity}: $${subtotal.toFixed(2)}%0A`;

                // Agregar a la historia de ventas
                salesHistory.push({
                    date: now,
                    ticketNumber: ticketNumber,
                    productName: item.name,
                    quantity: item.quantity,
                    price: item.price,
                    subtotal: subtotal,
                    paymentMethod: paymentMethod
                });
            }

            receiptHTML += `
                    </tbody>
                </table>
                <hr>
                <p class="text-end"><strong>Total: $${total.toFixed(2)}</strong></p>
                <div id="whatsappQR"></div>
                <button onclick="sendWhatsAppMessage()" class="btn btn-success mt-2">Enviar por WhatsApp</button>
            `;

            whatsappMessage += `%0A*Total: $${total.toFixed(2)}*`;

            receiptContent.innerHTML = receiptHTML;

            // Generar código QR para WhatsApp
            const qr = qrcode(0, 'M');
            qr.addData(`https://wa.me/?text=${encodeURIComponent(whatsappMessage)}`);
            qr.make();
            document.getElementById('whatsappQR').innerHTML = qr.createImgTag(5);

            // Actualizar totales de formas de pago
            paymentMethodTotals[paymentMethod] += total;

            const cartModal = bootstrap.Modal.getInstance(document.getElementById('cartModal'));
            cartModal.hide();

            const receiptModal = new bootstrap.Modal(document.getElementById('receiptModal'));
            receiptModal.show();

            // Limpiar el carrito después de finalizar la compra
            Object.keys(cart).forEach(key => delete cart[key]);
            updateCart();
        }

        function sendWhatsAppMessage() {
            const phoneNumber = prompt("Por favor, ingrese el número de teléfono del destinatario (incluya el código de país sin el '+'):");
            if (phoneNumber) {
                const whatsappMessage = document.getElementById('whatsappQR').querySelector('img').alt;
                const whatsappUrl = `https://wa.me/${phoneNumber}?text=${whatsappMessage}`;
                window.open(whatsappUrl, '_blank');
            }
        }

        // ... (el resto del código permanece igual) ...
    </script>
</body>
</html>